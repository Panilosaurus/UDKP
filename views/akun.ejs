<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>UDKP â€” Manajemen Akun</title>

  <!-- SB Admin 2 CSS -->
  <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css" />
  <link href="/css/sb-admin-2.min.css" rel="stylesheet" />
</head>

<body id="page-top">
  <!-- Page Wrapper -->
  <div id="wrapper">
    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
      <!-- Sidebar - Brand -->
      <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/">
        <div class="sidebar-brand-icon rotate-n-15">
          <i class="fas fa-laugh-wink"></i>
        </div>
        <div class="sidebar-brand-text mx-3">UDKP</div>
      </a>

      <!-- Divider -->
      <hr class="sidebar-divider my-0" />

      <!-- Nav Item - Dashboard -->
      <li class="nav-item">
        <a class="nav-link" href="/">
          <i class="fas fa-fw fa-tachometer-alt"></i>
          <span>Dashboard</span></a>
      </li>

      <!-- Nav Item - Manajemen Akun (active) -->
      <li class="nav-item active">
        <a class="nav-link" href="/akun">
          <i class="fas fa-users-cog"></i>
          <span>Manajemen Akun</span></a>
      </li>

      <!-- Divider -->
      <hr class="sidebar-divider d-none d-md-block" />

      <!-- Sidebar Toggler (Sidebar) -->
      <div class="text-center d-none d-md-inline">
        <button class="rounded-circle border-0" id="sidebarToggle"></button>
      </div>
    </ul>
    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
      <!-- Main Content -->
      <div id="content">
        <!-- Topbar -->
        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
          <!-- Sidebar Toggle (Topbar) -->
          <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
            <i class="fa fa-bars"></i>
          </button>

          <ul class="navbar-nav ml-auto">
            <!-- Nav Item - User Information (dummy) -->
            <li class="nav-item dropdown no-arrow">
              <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
                <span class="mr-2 d-none d-lg-inline text-gray-600 small">Admin</span>
                <img class="img-profile rounded-circle" src="/img/undraw_profile.svg" />
              </a>
              <!-- Dropdown - User Information -->
              <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="userDropdown">
                <a class="dropdown-item" href="#"><i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i> Profile</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="/logout"><i
                    class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i> Logout</a>
              </div>
            </li>
          </ul>
        </nav>
        <!-- End of Topbar -->

        <!-- Begin Page Content -->
        <div class="container-fluid">
          <!-- Page Heading -->
          <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <div>
              <h1 class="h3 mb-0 text-gray-800">Manajemen Akun</h1>
              <p class="text-muted mt-1 mb-0">Kelola pengguna yang memiliki akses ke sistem UDKP.</p>
            </div>

            <div class="text-right">
              <button class="btn btn-primary shadow-sm" data-toggle="modal" data-target="#modalTambahAkun">
                <i class="fas fa-user-plus fa-sm text-white-50 mr-1"></i>
                Tambah Akun
              </button>

              <button class="btn btn-outline-secondary shadow-sm ml-2" data-toggle="modal" data-target="#modalLogLogin">
                <i class="fas fa-history fa-sm mr-1"></i> Riwayat Login
              </button>
            </div>

          </div>

          <!-- Filters -->
          <div class="card shadow mb-4">
            <div class="card-body">
              <form class="row">
                <div class="col-md-4 mb-2">
                  <label class="small text-gray-600 mb-1">Cari (Nama / Username)</label>
                  <input id="filterKeyword" type="text" class="form-control" placeholder="ketik kata kunci..."
                    oninput="filterTable()" />
                </div>
                <div class="col-md-3 mb-2">
                  <label class="small text-gray-600 mb-1">Role</label>
                  <select id="filterRole" class="form-control" onchange="filterTable()">
                    <option value="">Semua</option>
                    <option value="admin">Admin</option>
                    <option value="petugas">Petugas</option>
                    <option value="viewer">Viewer</option>
                  </select>
                </div>
                <div class="col-md-3 mb-2">
                  <label class="small text-gray-600 mb-1">Status</label>
                  <select id="filterStatus" class="form-control" onchange="filterTable()">
                    <option value="">Semua</option>
                    <option value="aktif">Aktif</option>
                    <option value="nonaktif">Nonaktif</option>
                  </select>
                </div>
                <div class="col-md-2 d-flex align-items-end mb-2">
                  <button type="button" class="btn btn-outline-secondary w-100" onclick="resetFilter()">
                    <i class="fas fa-undo mr-1"></i>Reset
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Table -->
          <div class="card shadow mb-4">
            <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold text-primary">Daftar Akun</h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered" id="tabelAkun">
                  <thead>
                    <tr>
                      <th style="width:60px">No</th>
                      <th>Nama</th>
                      <th>Username</th>
                      <th style="width:140px">Role</th>
                      <th style="width:140px">Status</th>
                      <th style="width:200px">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyAkun">
                    <% if (Array.isArray(users) && users.length) { %>
                      <% users.forEach(function(u, i) { %>
                        <tr data-role="<%= u.role %>" data-status="<%= u.status %>"
                          data-keyword="<%= (u.nama + ' ' + u.username).toLowerCase() %>">
                          <td class="text-center">
                            <%= i + 1 %>
                          </td>

                          <!-- Nama (gabungan nama_depan + nama_belakang) -->
                          <td>
                            <%= u.nama %>
                          </td>

                          <!-- Username -->
                          <td><code><%= u.username %></code></td>

                          <!-- Role -->
                          <td>
                            <span
                              class="badge <%= u.role === 'admin' ? 'badge-danger' : (u.role === 'petugas' ? 'badge-info' : 'badge-secondary') %>">
                              <%= (u.role || '' ).toUpperCase() %>
                            </span>
                          </td>

                          <!-- Status -->
                          <td>
                            <% if (u.status==='aktif' ) { %>
                              <span class="badge badge-success">Aktif</span>
                              <% } else { %>
                                <span class="badge badge-secondary">Nonaktif</span>
                                <% } %>
                          </td>

                          <!-- Aksi: Edit / Toggle Aktif / Reset Password / Hapus -->
                          <td class="text-nowrap">
                            <!-- Edit (buka modal Edit Akun) -->
                            <button type="button" class="btn btn-sm btn-warning mr-1 btnEditAkun" title="Edit"
                              data-id="<%= u.id %>" data-nama-depan="<%= u.nama_depan %>"
                              data-nama-belakang="<%= u.nama_belakang %>" data-username="<%= u.username %>"
                              data-role="<%= (u.role || '').toUpperCase() %>"
                              data-status="<%= (u.status || '').toUpperCase() %>">
                              <i class="fas fa-edit"></i>
                            </button>


                            <!-- Toggle Aktif/Nonaktif -->
                            <!-- Toggle Aktif/Nonaktif -->
                            <form action="/akun/toggle/<%= u.id %>" method="POST" class="d-inline form-toggle-akun">
                              <button type="submit"
                                class="btn btn-sm <%= u.status === 'aktif' ? 'btn-outline-secondary' : 'btn-outline-success' %> mr-1"
                                title="Toggle Aktif">
                                <i class="fas <%= u.status === 'aktif' ? 'fa-user-slash' : 'fa-user-check' %>"></i>
                              </button>
                            </form>


                            <!-- Reset Password (akan set ke default di backend) -->
                            <form action="/akun/reset-password/<%= u.id %>" method="POST" class="d-inline"
                              onsubmit="return confirm('Reset password untuk <%= u.username %>?');">
                              <button type="submit" class="btn btn-sm btn-outline-primary mr-1" title="Reset Password">
                                <i class="fas fa-key"></i>
                              </button>
                            </form>

                            <!-- Hapus -->
                            <form action="/akun/delete/<%= u.id %>" method="POST" class="d-inline form-hapus-akun">
                              <button type="submit" class="btn btn-sm btn-danger" title="Hapus">
                                <i class="fas fa-trash"></i>
                              </button>
                            </form>


                          </td>
                        </tr>
                        <% }) %>
                          <% } else { %>
                            <tr>
                              <td colspan="6" class="text-center text-muted">Belum ada data akun.</td>
                            </tr>
                            <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- /.container-fluid -->
      </div>
      <!-- End of Main Content -->

      <!-- Footer -->
      <footer class="sticky-footer bg-white">
        <div class="container my-auto">
          <div class="copyright text-center my-auto">
            <span>Â© UDKP Dashboard 2025</span>
          </div>
        </div>
      </footer>
      <!-- End of Footer -->
    </div>
    <!-- End of Content Wrapper -->
  </div>
  <!-- End of Page Wrapper -->

  <!-- Scroll to Top Button-->
  <a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
  </a>

  <!-- Modal: Tambah Akun -->
  <div class="modal fade" id="modalTambahAkun" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <!-- KOSONGKAN action agar tidak submit default -->
      <form id="formTambahAkun" action="" method="POST" class="modal-content" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Tambah Akun Baru</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
              aria-hidden="true">&times;</span></button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label>Nama Depan</label>
            <input type="text" class="form-control" id="nama_depan" name="nama_depan" required />
            <small class="text-danger d-block" data-error="nama_depan"></small>
          </div>

          <div class="form-group">
            <label>Nama Belakang</label>
            <input type="text" class="form-control" id="nama_belakang" name="nama_belakang" />
            <small class="text-danger d-block" data-error="nama_belakang"></small>
          </div>

          <div class="form-group">
            <label>Username</label>
            <input type="text" class="form-control" id="username" name="username" required />
            <small class="text-danger d-block" data-error="username"></small>
          </div>

          <div class="form-group">
            <label>Password</label>
            <input type="password" class="form-control" id="password" name="password" minlength="6" required />
            <small class="text-muted">Minimal 6 karakter.</small>
            <small class="text-danger d-block" data-error="password"></small>
          </div>

          <div class="form-group">
            <label>Role</label>
            <select class="form-control" id="role" name="role" required>
              <option value="PETUGAS">Petugas</option>
              <option value="ADMIN">Admin</option>
              <option value="VIEWER">Viewer</option>
            </select>
            <small class="text-danger d-block" data-error="role"></small>
          </div>

          <div class="form-group">
            <label>Status</label>
            <select class="form-control" id="status" name="status" required>
              <option value="AKTIF">Aktif</option>
              <option value="NONAKTIF">Nonaktif</option>
            </select>
            <small class="text-danger d-block" data-error="status"></small>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-dismiss="modal">Batal</button>
          <button type="submit" id="btnSimpanAkun" class="btn btn-success">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Edit Akun -->
  <div class="modal fade" id="modalEditAkun" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <form id="formEditAkun" action="" method="POST" class="modal-content" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Edit Akun</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="edit_id" name="id" />

          <div class="form-group">
            <label>Nama Depan</label>
            <input type="text" class="form-control" id="edit_nama_depan" name="nama_depan" required />
            <small class="text-danger d-block" data-error="nama_depan"></small>
          </div>

          <div class="form-group">
            <label>Nama Belakang</label>
            <input type="text" class="form-control" id="edit_nama_belakang" name="nama_belakang" />
            <small class="text-danger d-block" data-error="nama_belakang"></small>
          </div>

          <div class="form-group">
            <label>Username</label>
            <input type="text" class="form-control" id="edit_username" name="username" disabled />
            <small class="text-muted">Username tidak bisa diubah.</small>
          </div>

          <div class="form-group">
            <label>Password Baru</label>
            <input type="password" class="form-control" id="edit_password" name="password" minlength="6" />
            <small class="text-muted">Kosongkan jika tidak ingin mengubah password.</small>
          </div>

          <div class="form-group">
            <label>Role</label>
            <select class="form-control" id="edit_role" name="role" required>
              <option value="PETUGAS">Petugas</option>
              <option value="ADMIN">Admin</option>
              <option value="VIEWER">Viewer</option>
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-dismiss="modal">Batal</button>
          <button type="submit" id="btnUpdateAkun" class="btn btn-warning">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Riwayat Login -->
  <div class="modal fade" id="modalLogLogin" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-history mr-2"></i>Riwayat Login</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <form class="form-row mb-3">
            <div class="col-md-4">
              <input id="logQ" type="text" class="form-control" placeholder="Cari username / IP / alasan...">
            </div>
            <div class="col-md-3">
              <select id="logSuccess" class="form-control">
                <option value="">Semua</option>
                <option value="1">Sukses</option>
                <option value="0">Gagal</option>
              </select>
            </div>
          </form>

          <div class="table-responsive">
            <table class="table table-bordered table-sm">
              <thead>
                <tr>
                  <th style="width:160px">Waktu</th>
                  <th>Username</th>
                  <th>IP</th>
                  <th>UA (Browser)</th>
                  <th style="width:90px">Status</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody id="tbodyLoginLog">
                <tr>
                  <td colspan="6" class="text-center text-muted">Belum ada data</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-2">
            <small id="logInfo" class="text-muted"></small>
            <div>
              <button class="btn btn-light btn-sm" id="prevLog">&laquo; Prev</button>
              <button class="btn btn-light btn-sm" id="nextLog">Next &raquo;</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- SB Admin 2 JS -->
  <script src="/vendor/jquery/jquery.min.js"></script>
  <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/vendor/jquery-easing/jquery.easing.min.js"></script>
  <script src="/js/sb-admin-2.min.js"></script>

  <script>
    function filterTable() {
      const kw = (document.getElementById('filterKeyword').value || '').toLowerCase();
      const role = document.getElementById('filterRole').value;
      const status = document.getElementById('filterStatus').value;
      const rows = document.querySelectorAll('#tabelAkun tbody tr');

      rows.forEach((row) => {
        const r = row.getAttribute('data-role') || '';
        const s = row.getAttribute('data-status') || '';
        const k = row.getAttribute('data-keyword') || '';
        const matchKw = kw ? k.includes(kw) : true;
        const matchRole = role ? r === role : true;
        const matchStatus = status ? s === status : true;
        row.style.display = matchKw && matchRole && matchStatus ? '' : 'none';
      });
    }

    function resetFilter() {
      document.getElementById('filterKeyword').value = '';
      document.getElementById('filterRole').value = '';
      document.getElementById('filterStatus').value = '';
      filterTable();
    }
  </script>

  <script>
    (function () {
      const form = document.getElementById('formTambahAkun');
      const btn = document.getElementById('btnSimpanAkun');
      const tbody = document.getElementById('tbodyAkun');

      $('#modalTambahAkun').on('show.bs.modal', function () {
        form.reset();
        clearMsgs();
      });

      function clearMsgs() {
        document.querySelectorAll('[data-error]').forEach(el => el.textContent = '');
      }
      function showErr(name, msg) {
        const el = document.querySelector(`[data-error="${name}"]`);
        if (el) el.textContent = msg || '';
      }

      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        clearMsgs();

        const payload = {
          nama_depan: document.getElementById('nama_depan').value.trim(),
          nama_belakang: document.getElementById('nama_belakang').value.trim(),
          username: document.getElementById('username').value.trim(),
          password: document.getElementById('password').value,
          role: (document.getElementById('role').value || 'VIEWER').toUpperCase(),
          status: (document.getElementById('status').value || 'AKTIF').toUpperCase()
        };

        // âœ… Validasi yang benar
        if (!payload.nama_depan) return showErr('nama_depan', 'Nama depan wajib diisi');
        if (!payload.username) return showErr('username', 'Username wajib diisi');
        if (!payload.password || payload.password.length < 6)
          return showErr('password', 'Password minimal 6 karakter');

        const original = btn.textContent;
        btn.disabled = true; btn.textContent = 'Menyimpan...';

        try {
          const res = await fetch('/akun', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify(payload)
          });

          // Coba baca sebagai text lalu parse ke JSON agar tidak meledak
          const raw = await res.text();
          let data = {};
          try { data = raw ? JSON.parse(raw) : {}; } catch { data = {}; }

          if (!res.ok || !data.ok) {
            if (data.field && data.message) {
              showErr(data.field, data.message);
            } else if (data.message) {
              showErr('username', data.message);
            } else {
              // tampilkan status dari server bila ada (mis. 401/403/500)
              alert(`Gagal menyimpan akun. Status: ${res.status}`);
            }
            return;
          }

          // === SUKSES ===
          $('#modalTambahAkun').modal('hide');

          // kalau mau simple reload aja
          // window.location.reload(); return;

          if (!tbody) { window.location.reload(); return; }

          const roleBadge = (r) => {
            const m = { ADMIN: 'danger', PETUGAS: 'info', VIEWER: 'secondary' };
            return `<span class="badge badge-${m[r] || 'secondary'}">${r}</span>`;
          };
          const statusBadge = (s) => {
            const m = { AKTIF: 'success', NONAKTIF: 'secondary' };
            return `<span class="badge badge-${m[s] || 'secondary'}">${s === 'AKTIF' ? 'Aktif' : 'Nonaktif'}</span>`;
          };

          const nomor = (tbody.querySelectorAll('tr').length + 1);
          const namaLengkap = `${payload.nama_depan}${payload.nama_belakang ? ' ' + payload.nama_belakang : ''}`.trim();

          const row = document.createElement('tr');
          row.setAttribute('data-role', payload.role.toLowerCase());
          row.setAttribute('data-status', payload.status.toLowerCase());
          row.setAttribute('data-keyword', `${namaLengkap} ${payload.username}`.toLowerCase());

          // Lengkapi 6 kolom sesuai header
          row.innerHTML = `
  <td class="text-center">${nomor}</td>
  <td>${namaLengkap}</td>
  <td><code>${payload.username}</code></td>
  <td class="text-center">${roleBadge(payload.role)}</td>
  <td class="text-center">${statusBadge(payload.status)}</td>
  <td class="text-nowrap text-center">
    <button class="btn btn-sm btn-warning mr-1" title="Edit"><i class="fas fa-edit"></i></button>
    <button class="btn btn-sm btn-outline-secondary mr-1" title="Toggle Aktif"><i class="fas fa-user-slash"></i></button>
    <button class="btn btn-sm btn-outline-primary mr-1" title="Reset Password"><i class="fas fa-key"></i></button>
    <button class="btn btn-sm btn-danger" title="Hapus"><i class="fas fa-trash"></i></button>
  </td>
`;
          tbody.appendChild(row);

        } catch (err) {
          console.error(err);
          alert('Terjadi kesalahan jaringan/server.');
        } finally {
          // apapun yang terjadi, tombol dibalikin normal
          btn.disabled = false;
          btn.textContent = 'Simpan';
        }

      });
    })();
  </script>
  <script>
    $(document).on('click', '.btnEditAkun', function () {
      $('#edit_id').val($(this).data('id'));
      $('#edit_nama_depan').val($(this).data('nama-depan'));
      $('#edit_nama_belakang').val($(this).data('nama-belakang'));
      $('#edit_username').val($(this).data('username'));
      $('#edit_role').val($(this).data('role')); // role masih dipakai
      $('#edit_password').val('');
      $('#modalEditAkun').modal('show');
    });

    $(document).on('click', '.btnEditAkun', function () {
      $('#edit_id').val($(this).data('id'));
      $('#edit_nama_depan').val($(this).data('nama-depan'));
      $('#edit_nama_belakang').val($(this).data('nama-belakang'));
      $('#edit_username').val($(this).data('username'));
      $('#edit_role').val($(this).data('role'));
      $('#edit_password').val('');
      $('#modalEditAkun').modal('show');
    });

    $('#formEditAkun').on('submit', async function (e) {
      e.preventDefault();

      const id = $('#edit_id').val();
      const namaDepan = $('#edit_nama_depan').val().trim();
      const namaBelakang = $('#edit_nama_belakang').val().trim();

      const payload = {
        nama_depan: namaDepan,
        nama_belakang: namaBelakang,
        password: $('#edit_password').val(),
        role: $('#edit_role').val().toUpperCase()
      };

      // ðŸ§© Validasi input
      if (!namaDepan && !namaBelakang) {
        return Swal.fire({
          icon: 'warning',
          title: 'Peringatan',
          text: 'Nama depan dan nama belakang wajib diisi.'
        });
      } else if (!namaDepan) {
        return Swal.fire({
          icon: 'warning',
          title: 'Peringatan',
          text: 'Nama depan wajib diisi.'
        });
      } else if (!namaBelakang) {
        return Swal.fire({
          icon: 'warning',
          title: 'Peringatan',
          text: 'Nama belakang wajib diisi.'
        });
      }

      const btn = $('#btnUpdateAkun');
      btn.prop('disabled', true).text('Menyimpan...');

      try {
        const res = await fetch(`/akun/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          credentials: 'same-origin'
        });

        const data = await res.json();

        if (data.ok) {
          await Swal.fire({
            icon: 'success',
            title: 'Berhasil!',
            text: data.message || 'Akun berhasil diperbarui.',
            timer: 1500,
            showConfirmButton: false
          });
          location.reload();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Gagal!',
            text: data.message || 'Tidak dapat memperbarui akun.'
          });
        }
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Kesalahan Server',
          text: 'Terjadi kesalahan koneksi atau server.'
        });
      } finally {
        btn.prop('disabled', false).text('Update');
      }
    });
  </script>


  <script>
    (function () {
      // Helper untuk ganti class badge
      function setBadge(el, active) {
        el.classList.remove('badge-success', 'badge-secondary');
        el.classList.add(active ? 'badge-success' : 'badge-secondary');
        el.textContent = active ? 'Aktif' : 'Nonaktif';
      }

      // Helper untuk ganti tampilan tombol toggle (ikon & warna)
      function setToggleBtn(btn, active) {
        btn.classList.remove('btn-outline-secondary', 'btn-outline-success');
        // Jika status AKTIF, maka tombol menunjukkan aksi "nonaktifkan" (slash)
        if (active) {
          btn.classList.add('btn-outline-secondary');
          btn.querySelector('i').classList.remove('fa-user-check');
          btn.querySelector('i').classList.add('fa-user-slash');
        } else {
          // Jika status NONAKTIF, tombol menunjukkan aksi "aktifkan" (check)
          btn.classList.add('btn-outline-success');
          btn.querySelector('i').classList.remove('fa-user-slash');
          btn.querySelector('i').classList.add('fa-user-check');
        }
      }

      document.querySelectorAll('.form-toggle-akun').forEach(form => {
        form.addEventListener('submit', async function (e) {
          e.preventDefault();

          const row = form.closest('tr');
          const username = row.querySelector('code')?.textContent?.trim() || 'pengguna ini';
          const statusCell = row.querySelector('td:nth-child(5) span'); // kolom Status
          const btn = form.querySelector('button');

          try {
            const res = await fetch(form.action, {
              method: 'POST',
              headers: { 'Accept': 'application/json' } // minta JSON
            });

            // Server akan mengembalikan JSON { ok: true, status: 'AKTIF' | 'NONAKTIF' }
            const data = await res.json().catch(() => ({}));

            if (!res.ok || !data.ok) {
              throw new Error(data.message || `Gagal mengubah status akun ${username}.`);
            }

            const isActive = String(data.status).toUpperCase() === 'AKTIF';

            // Update UI: badge status, tombol, dan atribut filter
            if (statusCell) setBadge(statusCell, isActive);
            setToggleBtn(btn, isActive);
            row.setAttribute('data-status', isActive ? 'aktif' : 'nonaktif');

            await Swal.fire({
              icon: 'success',
              title: 'Berhasil',
              text: `Status akun ${username} diubah menjadi ${isActive ? 'Aktif' : 'Nonaktif'}.`,
              timer: 1800,
              showConfirmButton: false
            });
          } catch (err) {
            console.error(err);
            Swal.fire({
              icon: 'error',
              title: 'Gagal',
              text: err.message || 'Terjadi kesalahan saat mengubah status.'
            });
          }
        });
      });
    })();
  </script>

  <script>
    document.querySelectorAll('.form-hapus-akun').forEach(form => {
      form.addEventListener('submit', async function (e) {
        e.preventDefault();

        const row = form.closest('tr');
        const username = row.querySelector('code')?.textContent?.trim() || 'pengguna ini';

        // ðŸŸ  Konfirmasi hapus
        const result = await Swal.fire({
          title: 'Yakin ingin menghapus akun?',
          html: `Akun <b>${username}</b> akan dihapus dan tindakan ini <b>tidak dapat dibatalkan</b>.`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Ya, hapus',
          cancelButtonText: 'Batal',
          reverseButtons: true
        });

        if (!result.isConfirmed) return;

        try {
          const res = await fetch(form.action, {
            method: 'POST',
            headers: { 'Accept': 'application/json' }
          });
          const data = await res.json().catch(() => ({}));

          if (res.ok && data.ok) {
            // âœ… Pesan sukses
            await Swal.fire({
              icon: 'success',
              title: 'Berhasil',
              text: 'Akun berhasil dihapus!',
              timer: 2000,
              showConfirmButton: false
            });

            // Hapus baris dari tabel tanpa reload
            row.remove();

          } else {
            Swal.fire({
              icon: 'error',
              title: 'Gagal',
              text: data.message || 'Gagal menghapus akun.'
            });
          }
        } catch (err) {
          console.error(err);
          Swal.fire({
            icon: 'error',
            title: 'Kesalahan',
            text: 'Terjadi kesalahan koneksi ke server.'
          });
        }
      });
    });
  </script>

  <script>
    (function () {
      let page = 1, limit = 10;

      async function loadLogs() {
        const q = document.getElementById('logQ').value.trim();
        const success = document.getElementById('logSuccess').value;
        const params = new URLSearchParams({ page, limit });
        if (q) params.append('q', q);
        if (success !== '') params.append('success', success);

        const res = await fetch('/akun/logs?' + params.toString(), { headers: { 'Accept': 'application/json' } });
        const data = await res.json();
        const tbody = document.getElementById('tbodyLoginLog');

        if (!res.ok || !data.ok) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Gagal memuat log.</td></tr>`;
          return;
        }

        if (!data.rows.length) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Tidak ada data login.</td></tr>`;
          document.getElementById('logInfo').textContent = '';
          return;
        }

        tbody.innerHTML = data.rows.map(r => `
      <tr>
        <td><code>${new Date(r.created_at).toLocaleString()}</code></td>
        <td>${r.username || '-'}</td>
        <td><code>${r.ip}</code></td>
        <td title="${(r.user_agent || '').replace(/"/g, '&quot;')}">
          ${(r.user_agent || '').slice(0, 40)}${(r.user_agent || '').length > 40 ? 'â€¦' : ''}
        </td>
        <td class="text-center">
          <span class="badge ${r.success ? 'badge-success' : 'badge-danger'}">${r.success ? 'Sukses' : 'Gagal'}</span>
        </td>
        <td>${r.reason || '-'}</td>
      </tr>
    `).join('');

        const start = (data.page - 1) * data.limit + 1;
        const end = Math.min(data.page * data.limit, data.total);
        document.getElementById('logInfo').textContent =
          `Menampilkan ${start}â€“${end} dari ${data.total} log.`;
        document.getElementById('prevLog').disabled = (page <= 1);
        document.getElementById('nextLog').disabled = (end >= data.total);
      }

      $('#modalLogLogin').on('show.bs.modal', function () {
        page = 1;
        loadLogs();
      });

      document.getElementById('btnFilterLog').addEventListener('click', function () {
        page = 1;
        loadLogs();
      });
      document.getElementById('prevLog').addEventListener('click', function () {
        if (page > 1) { page--; loadLogs(); }
      });
      document.getElementById('nextLog').addEventListener('click', function () {
        page++; loadLogs();
      });
    })();
  </script>

  <script>
    (function () {
      const tbody = document.getElementById('tbodyLoginLog');
      const info = document.getElementById('logInfo');
      const btnPrev = document.getElementById('prevLog');
      const btnNext = document.getElementById('nextLog');
      const inpQ = document.getElementById('logQ');
      const selSuccess = document.getElementById('logSuccess');

      let currentPage = 1;
      const limit = 10;
      let totalPages = 1;

      // --- debounce supaya gak spam fetch pas ngetik ---
      let typingTimer = null;
      const DEBOUNCE_MS = 350;
      function debounceLoad(page = 1) {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => loadLogs(page), DEBOUNCE_MS);
      }

      async function loadLogs(page = 1) {
        const q = (inpQ.value || '').trim();
        const success = selSuccess.value; // '' | '1' | '0'

        const params = new URLSearchParams({
          page: page,
          limit: limit
        });
        if (q) params.append('q', q);
        if (success !== '') params.append('success', success);

        try {
          const res = await fetch('/akun/login-log?' + params.toString(), {
            headers: { 'Accept': 'application/json' }
          });
          const data = await res.json();
          if (!data.ok) throw new Error(data.message || 'Gagal load data');

          currentPage = data.page;
          totalPages = data.totalPages;

          // bersihkan tbody
          tbody.innerHTML = '';

          if (!data.data.length) {
            tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center text-muted">Tidak ada log.</td>
            </tr>
          `;
          } else {
            data.data.forEach((row) => {
              const tr = document.createElement('tr');

              const badge = row.success
                ? '<span class="badge badge-success">Sukses</span>'
                : '<span class="badge badge-danger">Gagal</span>';

              tr.innerHTML = `
              <td style="white-space:nowrap;">${row.created_at_fmt || ''}</td>
              <td>${row.username || '-'}</td>
              <td>${row.ip || '-'}</td>
              <td style="max-width:240px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${row.user_agent || ''}">
                ${row.user_agent || '-'}
              </td>
              <td class="text-center">${badge}</td>
              <td>${row.reason || '-'}</td>
            `;
              tbody.appendChild(tr);
            });
          }

          // info bawah
          const start = (data.page - 1) * data.limit + 1;
          const end = Math.min(data.page * data.limit, data.total);
          info.textContent = `Menampilkan ${start}-${end} dari ${data.total} log.`;

          // kontrol tombol
          btnPrev.disabled = (currentPage <= 1);
          btnNext.disabled = (currentPage >= totalPages);

        } catch (err) {
          console.error(err);
          tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-danger">Gagal memuat data.</td>
          </tr>
        `;
          info.textContent = '';
        }
      }

      // ðŸ”Ž ngetik â†’ langsung cari (dengan debounce)
      inpQ.addEventListener('input', function () {
        debounceLoad(1);
      });

      // ðŸŸ¢ pilih dropdown â†’ langsung cari
      selSuccess.addEventListener('change', function () {
        loadLogs(1);
      });

      // prev / next
      btnPrev.addEventListener('click', function () {
        if (currentPage > 1) {
          loadLogs(currentPage - 1);
        }
      });
      btnNext.addEventListener('click', function () {
        if (currentPage < totalPages) {
          loadLogs(currentPage + 1);
        }
      });

      // pas modal dibuka â†’ load halaman 1
      $('#modalLogLogin').on('shown.bs.modal', function () {
        loadLogs(1);
      });
    })();
  </script>


</body>

</html>