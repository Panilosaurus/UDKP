<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>UDKP — Manajemen Akun</title>

  <!-- SB Admin 2 CSS -->
  <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css" />
  <link href="/css/sb-admin-2.min.css" rel="stylesheet" />
</head>

<body id="page-top">
  <!-- Page Wrapper -->
  <div id="wrapper">
    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
      <!-- Sidebar - Brand -->
      <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/">
        <div class="sidebar-brand-icon rotate-n-15">
          <i class="fas fa-laugh-wink"></i>
        </div>
        <div class="sidebar-brand-text mx-3">UDKP</div>
      </a>

      <!-- Divider -->
      <hr class="sidebar-divider my-0" />

      <!-- Nav Item - Dashboard -->
      <li class="nav-item">
        <a class="nav-link" href="/">
          <i class="fas fa-fw fa-tachometer-alt"></i>
          <span>Dashboard</span></a>
      </li>

      <!-- Nav Item - Manajemen Akun (active) -->
      <li class="nav-item active">
        <a class="nav-link" href="/akun">
          <i class="fas fa-users-cog"></i>
          <span>Manajemen Akun</span></a>
      </li>

      <!-- Divider -->
      <hr class="sidebar-divider d-none d-md-block" />

      <!-- Sidebar Toggler (Sidebar) -->
      <div class="text-center d-none d-md-inline">
        <button class="rounded-circle border-0" id="sidebarToggle"></button>
      </div>
    </ul>
    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
      <!-- Main Content -->
      <div id="content">
        <!-- Topbar -->
        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
          <!-- Sidebar Toggle (Topbar) -->
          <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
            <i class="fa fa-bars"></i>
          </button>

          <ul class="navbar-nav ml-auto">
            <!-- Nav Item - User Information (dummy) -->
            <li class="nav-item dropdown no-arrow">
              <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
                <span class="mr-2 d-none d-lg-inline text-gray-600 small">Admin</span>
                <img class="img-profile rounded-circle" src="/img/undraw_profile.svg" />
              </a>
              <!-- Dropdown - User Information -->
              <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="userDropdown">
                <a class="dropdown-item" href="#"><i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i> Profile</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="/logout"><i
                    class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i> Logout</a>
              </div>
            </li>
          </ul>
        </nav>
        <!-- End of Topbar -->

        <!-- Begin Page Content -->
        <div class="container-fluid">
          <!-- Page Heading -->
          <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <div>
              <h1 class="h3 mb-0 text-gray-800">Manajemen Akun</h1>
              <p class="text-muted mt-1 mb-0">Kelola pengguna yang memiliki akses ke sistem UDKP.</p>
            </div>
            <div class="text-right">
              <button class="btn btn-primary shadow-sm" data-toggle="modal" data-target="#modalTambahAkun">
                <i class="fas fa-user-plus fa-sm text-white-50 mr-1"></i>
                Tambah Akun
              </button>
            </div>
          </div>

          <!-- Filters -->
          <div class="card shadow mb-4">
            <div class="card-body">
              <form class="row">
                <div class="col-md-4 mb-2">
                  <label class="small text-gray-600 mb-1">Cari (Nama / Username)</label>
                  <input id="filterKeyword" type="text" class="form-control" placeholder="ketik kata kunci..."
                    oninput="filterTable()" />
                </div>
                <div class="col-md-3 mb-2">
                  <label class="small text-gray-600 mb-1">Role</label>
                  <select id="filterRole" class="form-control" onchange="filterTable()">
                    <option value="">Semua</option>
                    <option value="admin">Admin</option>
                    <option value="petugas">Petugas</option>
                    <option value="viewer">Viewer</option>
                  </select>
                </div>
                <div class="col-md-3 mb-2">
                  <label class="small text-gray-600 mb-1">Status</label>
                  <select id="filterStatus" class="form-control" onchange="filterTable()">
                    <option value="">Semua</option>
                    <option value="aktif">Aktif</option>
                    <option value="nonaktif">Nonaktif</option>
                  </select>
                </div>
                <div class="col-md-2 d-flex align-items-end mb-2">
                  <button type="button" class="btn btn-outline-secondary w-100" onclick="resetFilter()">
                    <i class="fas fa-undo mr-1"></i>Reset
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Table -->
          <div class="card shadow mb-4">
            <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold text-primary">Daftar Akun</h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered" id="tabelAkun">
                  <thead>
                    <tr>
                      <th style="width:60px">No</th>
                      <th>Nama</th>
                      <th>Username</th>
                      <th style="width:140px">Role</th>
                      <th style="width:140px">Status</th>
                      <th style="width:200px">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyAkun">
                    <% if (Array.isArray(users) && users.length) { %>
                      <% users.forEach(function(u, i) { %>
                        <tr>
                          <td class="text-center">
                            <%= i + 1 %>
                          </td>

                          <!-- Nama (gabungan nama_depan + nama_belakang) -->
                          <td>
                            <%= u.nama %>
                          </td>

                          <!-- Username -->
                          <td><code><%= u.username %></code></td>

                          <!-- Role -->
                          <td>
                            <span
                              class="badge <%= u.role === 'admin' ? 'badge-danger' : (u.role === 'petugas' ? 'badge-info' : 'badge-secondary') %>">
                              <%= (u.role || '' ).toUpperCase() %>
                            </span>
                          </td>

                          <!-- Status -->
                          <td>
                            <% if (u.status==='aktif' ) { %>
                              <span class="badge badge-success">Aktif</span>
                              <% } else { %>
                                <span class="badge badge-secondary">Nonaktif</span>
                                <% } %>
                          </td>

                          <!-- Aksi: Edit / Toggle Aktif / Reset Password / Hapus -->
                          <td class="text-nowrap">
                            <!-- Edit (buka modal Edit Akun) -->
                            <button type="button" class="btn btn-sm btn-warning mr-1 btnEditAkun" title="Edit" data-id="<%= u.id %>"
                              data-nama-depan="<%= u.nama_depan %>" data-nama-belakang="<%= u.nama_belakang %>" data-username="<%= u.username %>"
                              data-role="<%= (u.role || '').toUpperCase() %>" data-status="<%= (u.status || '').toUpperCase() %>">
                              <i class="fas fa-edit"></i>
                            </button>


                            <!-- Toggle Aktif/Nonaktif -->
                            <form action="/akun/toggle/<%= u.id %>" method="POST" class="d-inline">
                              <button type="submit"
                                class="btn btn-sm <%= u.status === 'aktif' ? 'btn-outline-secondary' : 'btn-outline-success' %> mr-1"
                                title="Toggle Aktif">
                                <i class="fas <%= u.status === 'aktif' ? 'fa-user-slash' : 'fa-user-check' %>"></i>
                              </button>
                            </form>

                            <!-- Reset Password (akan set ke default di backend) -->
                            <form action="/akun/reset-password/<%= u.id %>" method="POST" class="d-inline"
                              onsubmit="return confirm('Reset password untuk <%= u.username %>?');">
                              <button type="submit" class="btn btn-sm btn-outline-primary mr-1" title="Reset Password">
                                <i class="fas fa-key"></i>
                              </button>
                            </form>

                            <!-- Hapus -->
                            <form action="/akun/delete/<%= u.id %>" method="POST" class="d-inline"
                              onsubmit="return confirm('Hapus akun <%= u.username %>? Tindakan ini tidak dapat dibatalkan.');">
                              <button type="submit" class="btn btn-sm btn-danger" title="Hapus">
                                <i class="fas fa-trash"></i>
                              </button>
                            </form>
                          </td>
                        </tr>
                        <% }) %>
                          <% } else { %>
                            <tr>
                              <td colspan="6" class="text-center text-muted">Belum ada data akun.</td>
                            </tr>
                            <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- /.container-fluid -->
      </div>
      <!-- End of Main Content -->

      <!-- Footer -->
      <footer class="sticky-footer bg-white">
        <div class="container my-auto">
          <div class="copyright text-center my-auto">
            <span>© UDKP Dashboard 2025</span>
          </div>
        </div>
      </footer>
      <!-- End of Footer -->
    </div>
    <!-- End of Content Wrapper -->
  </div>
  <!-- End of Page Wrapper -->

  <!-- Scroll to Top Button-->
  <a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
  </a>

  <!-- Modal: Tambah Akun -->
  <div class="modal fade" id="modalTambahAkun" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <!-- KOSONGKAN action agar tidak submit default -->
      <form id="formTambahAkun" action="" method="POST" class="modal-content" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Tambah Akun Baru</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
              aria-hidden="true">&times;</span></button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label>Nama Depan</label>
            <input type="text" class="form-control" id="nama_depan" name="nama_depan" required />
            <small class="text-danger d-block" data-error="nama_depan"></small>
          </div>

          <div class="form-group">
            <label>Nama Belakang</label>
            <input type="text" class="form-control" id="nama_belakang" name="nama_belakang" />
            <small class="text-danger d-block" data-error="nama_belakang"></small>
          </div>

          <div class="form-group">
            <label>Username</label>
            <input type="text" class="form-control" id="username" name="username" required />
            <small class="text-danger d-block" data-error="username"></small>
          </div>

          <div class="form-group">
            <label>Password</label>
            <input type="password" class="form-control" id="password" name="password" minlength="6" required />
            <small class="text-muted">Minimal 6 karakter.</small>
            <small class="text-danger d-block" data-error="password"></small>
          </div>

          <div class="form-group">
            <label>Role</label>
            <select class="form-control" id="role" name="role" required>
              <option value="PETUGAS">Petugas</option>
              <option value="ADMIN">Admin</option>
              <option value="VIEWER">Viewer</option>
            </select>
            <small class="text-danger d-block" data-error="role"></small>
          </div>

          <div class="form-group">
            <label>Status</label>
            <select class="form-control" id="status" name="status" required>
              <option value="AKTIF">Aktif</option>
              <option value="NONAKTIF">Nonaktif</option>
            </select>
            <small class="text-danger d-block" data-error="status"></small>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-dismiss="modal">Batal</button>
          <button type="submit" id="btnSimpanAkun" class="btn btn-success">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Edit Akun -->
  <div class="modal fade" id="modalEditAkun" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <form id="formEditAkun" action="" method="POST" class="modal-content" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Edit Akun</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
  
        <div class="modal-body">
          <input type="hidden" id="edit_id" name="id" />
  
          <div class="form-group">
            <label>Nama Depan</label>
            <input type="text" class="form-control" id="edit_nama_depan" name="nama_depan" required />
            <small class="text-danger d-block" data-error="nama_depan"></small>
          </div>
  
          <div class="form-group">
            <label>Nama Belakang</label>
            <input type="text" class="form-control" id="edit_nama_belakang" name="nama_belakang" />
            <small class="text-danger d-block" data-error="nama_belakang"></small>
          </div>
  
          <div class="form-group">
            <label>Username</label>
            <input type="text" class="form-control" id="edit_username" name="username" disabled />
            <small class="text-muted">Username tidak bisa diubah.</small>
          </div>
  
          <div class="form-group">
            <label>Password Baru</label>
            <input type="password" class="form-control" id="edit_password" name="password" minlength="6" />
            <small class="text-muted">Kosongkan jika tidak ingin mengubah password.</small>
          </div>
  
          <div class="form-group">
            <label>Role</label>
            <select class="form-control" id="edit_role" name="role" required>
              <option value="PETUGAS">Petugas</option>
              <option value="ADMIN">Admin</option>
              <option value="VIEWER">Viewer</option>
            </select>
          </div>
  
          <div class="form-group">
            <label>Status</label>
            <select class="form-control" id="edit_status" name="status" required>
              <option value="AKTIF">Aktif</option>
              <option value="NONAKTIF">Nonaktif</option>
            </select>
          </div>
        </div>
  
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-dismiss="modal">Batal</button>
          <button type="submit" id="btnUpdateAkun" class="btn btn-warning">Update</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- SB Admin 2 JS -->
  <script src="/vendor/jquery/jquery.min.js"></script>
  <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/vendor/jquery-easing/jquery.easing.min.js"></script>
  <script src="/js/sb-admin-2.min.js"></script>

  <script>
    function filterTable() {
      const kw = (document.getElementById('filterKeyword').value || '').toLowerCase();
      const role = document.getElementById('filterRole').value;
      const status = document.getElementById('filterStatus').value;
      const rows = document.querySelectorAll('#tabelAkun tbody tr');

      rows.forEach((row) => {
        const r = row.getAttribute('data-role') || '';
        const s = row.getAttribute('data-status') || '';
        const k = row.getAttribute('data-keyword') || '';
        const matchKw = kw ? k.includes(kw) : true;
        const matchRole = role ? r === role : true;
        const matchStatus = status ? s === status : true;
        row.style.display = matchKw && matchRole && matchStatus ? '' : 'none';
      });
    }

    function resetFilter() {
      document.getElementById('filterKeyword').value = '';
      document.getElementById('filterRole').value = '';
      document.getElementById('filterStatus').value = '';
      filterTable();
    }
  </script>

  <script>
    (function () {
      const form = document.getElementById('formTambahAkun');
      const btn = document.getElementById('btnSimpanAkun');
      const tbody = document.getElementById('tbodyAkun');

      $('#modalTambahAkun').on('show.bs.modal', function () {
        form.reset();
        clearMsgs();
      });

      function clearMsgs() {
        document.querySelectorAll('[data-error]').forEach(el => el.textContent = '');
      }
      function showErr(name, msg) {
        const el = document.querySelector(`[data-error="${name}"]`);
        if (el) el.textContent = msg || '';
      }

      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        clearMsgs();

        const payload = {
          nama_depan: document.getElementById('nama_depan').value.trim(),
          nama_belakang: document.getElementById('nama_belakang').value.trim(),
          username: document.getElementById('username').value.trim(),
          password: document.getElementById('password').value,
          role: (document.getElementById('role').value || 'VIEWER').toUpperCase(),
          status: (document.getElementById('status').value || 'AKTIF').toUpperCase()
        };

        // ✅ Validasi yang benar
        if (!payload.nama_depan) return showErr('nama_depan', 'Nama depan wajib diisi');
        if (!payload.username) return showErr('username', 'Username wajib diisi');
        if (!payload.password || payload.password.length < 6)
          return showErr('password', 'Password minimal 6 karakter');

        const original = btn.textContent;
        btn.disabled = true; btn.textContent = 'Menyimpan...';

        try {
          const res = await fetch('/akun', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify(payload)
          });

          // Coba baca sebagai text lalu parse ke JSON agar tidak meledak
          const raw = await res.text();
          let data = {};
          try { data = raw ? JSON.parse(raw) : {}; } catch { data = {}; }

          if (!res.ok || !data.ok) {
            if (data.field && data.message) {
              showErr(data.field, data.message);
            } else if (data.message) {
              showErr('username', data.message);
            } else {
              // tampilkan status dari server bila ada (mis. 401/403/500)
              alert(`Gagal menyimpan akun. Status: ${res.status}`);
            }
            return;
          }

          // === SUKSES ===
          $('#modalTambahAkun').modal('hide');

          // kalau mau simple reload aja
          // window.location.reload(); return;

          if (!tbody) { window.location.reload(); return; }

          const roleBadge = (r) => {
            const m = { ADMIN: 'danger', PETUGAS: 'info', VIEWER: 'secondary' };
            return `<span class="badge badge-${m[r] || 'secondary'}">${r}</span>`;
          };
          const statusBadge = (s) => {
            const m = { AKTIF: 'success', NONAKTIF: 'secondary' };
            return `<span class="badge badge-${m[s] || 'secondary'}">${s === 'AKTIF' ? 'Aktif' : 'Nonaktif'}</span>`;
          };

          const nomor = (tbody.querySelectorAll('tr').length + 1);
          const namaLengkap = `${payload.nama_depan}${payload.nama_belakang ? ' ' + payload.nama_belakang : ''}`.trim();

          const row = document.createElement('tr');
          row.setAttribute('data-role', payload.role.toLowerCase());
          row.setAttribute('data-status', payload.status.toLowerCase());
          row.setAttribute('data-keyword', `${namaLengkap} ${payload.username}`.toLowerCase());

          // Lengkapi 6 kolom sesuai header
          row.innerHTML = `
  <td class="text-center">${nomor}</td>
  <td>${namaLengkap}</td>
  <td><code>${payload.username}</code></td>
  <td class="text-center">${roleBadge(payload.role)}</td>
  <td class="text-center">${statusBadge(payload.status)}</td>
  <td class="text-nowrap text-center">
    <button class="btn btn-sm btn-warning mr-1" title="Edit"><i class="fas fa-edit"></i></button>
    <button class="btn btn-sm btn-outline-secondary mr-1" title="Toggle Aktif"><i class="fas fa-user-slash"></i></button>
    <button class="btn btn-sm btn-outline-primary mr-1" title="Reset Password"><i class="fas fa-key"></i></button>
    <button class="btn btn-sm btn-danger" title="Hapus"><i class="fas fa-trash"></i></button>
  </td>
`;
          tbody.appendChild(row);

        } catch (err) {
          console.error(err);
          alert('Terjadi kesalahan jaringan/server.');
        } finally {
          // apapun yang terjadi, tombol dibalikin normal
          btn.disabled = false;
          btn.textContent = 'Simpan';
        }

      });
    })();
  </script>
<script>
  $(document).on('click', '.btnEditAkun', function () {
    const depan = $(this).data('nama-depan');
    const belakang = $(this).data('nama-belakang');
    console.log("DEBUG nama depan:", depan, "nama belakang:", belakang);
    const id = $(this).data('id');
    const namaDepan = $(this).data('nama-depan');
    const namaBelakang = $(this).data('nama-belakang');
    const username = $(this).data('username');
    const role = $(this).data('role');
    const status = $(this).data('status');

    $('#edit_id').val($(this).data('id'));
    $('#edit_nama_depan').val($(this).data('nama-depan'));
    $('#edit_nama_belakang').val($(this).data('nama-belakang'));
    $('#edit_username').val($(this).data('username'));
    $('#edit_role').val($(this).data('role'));     // value opsi: ADMIN/PETUGAS/VIEWER
    $('#edit_status').val($(this).data('status')); // value opsi: AKTIF/NONAKTIF
    $('#edit_password').val('');
    $('#modalEditAkun').modal('show');
  });

  $('#formEditAkun').on('submit', async function (e) {
      e.preventDefault();

      const id = $('#edit_id').val();
      const payload = {
        nama_depan: $('#edit_nama_depan').val().trim(),
        nama_belakang: $('#edit_nama_belakang').val().trim(),
        password: $('#edit_password').val(),
        role: $('#edit_role').val().toUpperCase(),
        status: $('#edit_status').val().toUpperCase()
      };

      if (!payload.nama_depan) {
        return Swal.fire({
          icon: 'warning',
          title: 'Peringatan',
          text: 'Nama depan wajib diisi.'
        });
      }

      const btn = $('#btnUpdateAkun');
      btn.prop('disabled', true).text('Menyimpan...');

      try {
        const res = await fetch(`/akun/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.ok) {
          await Swal.fire({
            icon: 'success',
            title: 'Berhasil!',
            text: data.message || 'Akun berhasil diperbarui.',
            timer: 1500,
            showConfirmButton: false
          });
          location.reload();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Gagal!',
            text: data.message || 'Tidak dapat memperbarui akun.'
          });
        }
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Kesalahan Server',
          text: 'Terjadi kesalahan koneksi atau server.'
        });
      } finally {
        btn.prop('disabled', false).text('Update');
      }
    });
</script>

<script>
  // Saat klik tombol edit → isi field (sudah kamu punya)
  $(document).on('click', '.btnEditAkun', function () {
    $('#edit_id').val($(this).data('id'));
    $('#edit_nama_depan').val($(this).data('nama-depan'));
    $('#edit_nama_belakang').val($(this).data('nama-belakang'));
    $('#edit_username').val($(this).data('username'));
    $('#edit_role').val($(this).data('role'));
    $('#edit_status').val($(this).data('status'));
    $('#edit_password').val('');
    $('#modalEditAkun').modal('show');
  });

  // Saat form edit dikirim
  $('#formEditAkun').on('submit', async function (e) {
    e.preventDefault();

    const id = $('#edit_id').val();
    const payload = {
      nama_depan: $('#edit_nama_depan').val().trim(),
      nama_belakang: $('#edit_nama_belakang').val().trim(),
      password: $('#edit_password').val(),
      role: $('#edit_role').val().toUpperCase(),
      status: $('#edit_status').val().toUpperCase()
    };

    if (!payload.nama_depan) {
      alert('Nama depan wajib diisi.');
      return;
    }

    const btn = $('#btnUpdateAkun');
    btn.prop('disabled', true).text('Menyimpan...');

    try {
      const res = await fetch(`/akun/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (data.ok) {
        alert('✅ ' + data.message);
        location.reload();
      } else {
        alert('⚠️ ' + (data.message || 'Gagal memperbarui akun.'));
      }
    } catch (err) {
      console.error(err);
      alert('❌ Terjadi kesalahan koneksi atau server.');
    } finally {
      btn.prop('disabled', false).text('Update');
    }
  });
</script>

</body>

</html>